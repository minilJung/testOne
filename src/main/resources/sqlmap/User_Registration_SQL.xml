<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ebc.ecard.mapper.UserRegistrationMapper">

    <!-- RegistrationBean 조회 기본 -->
    <sql id="selectRegistrationDefault">
        SELECT
            registration_id as registration_id,
            user_id as userId,
            registration_file_id as registrationFileId,
            files.file_name as fileName,
            files.file_path as filePath,
            ur.public_yn as publicYn,
            ur.created_at as createdAt,
            ur.last_updated_at as lastUpdatedAt
        FROM user_registration ur
        LEFT JOIN files
            ON ur.registration_file_id = files.file_id
    </sql>

    <select id="findByUserId" parameterType="String" resultType="UserRegistrationBean">
        <include refid="selectRegistrationDefault" />
        WHERE user_id = #{userId}
    </select>
    <select id="findUserRegistrations" parameterType="UserRegistrationFilterDto" resultType="UserRegistrationBean">
        <include refid="selectRegistrationDefault" />
        WHERE
            0 = 0
            <if test="userId != null and !''.equals(userId)">
                AND user_id = #{userId}
            </if>
            <if test="publicYn != null and !''.equals(publicYn)">
                AND public_yn = #{publicYn}
            </if>
    </select>

    <select id="getUserRegistrationImageByEcardId" parameterType="String" resultType="UserRegistrationBean">
        <include refid="selectRegistrationDefault" />
        WHERE user_id = (SELECT user_id FROM ecard WHERE ecard_id = #{ecardId})
    </select>

    <select id="findUserRegistrationById" parameterType="String" resultType="UserRegistrationBean">
        <include refid="selectRegistrationDefault" />
        WHERE
            registration_id = #{userId}
    </select>

    <update id="updateRegistration" parameterType="UserRegistrationBean">
        UPDATE user_registration
        SET
            registration_file_id = #{registrationFileId},
            public_yn = #{publicYn},
            last_updated_at = now()
        WHERE
            registration_id = #{registrationId}
    </update>

    <insert id="saveRegistration" parameterType="UserRegistrationBean">
        INSERT INTO user_registration(
            registration_id,
            user_id,
            registration_file_id,
            public_yn,
            created_at,
            last_updated_at
        ) VALUES (
            #{registrationId},
            #{userId},
            #{registrationFileId},
            #{publicYn},
            #{createdAt},
            #{lastUpdatedAt}
        )
    </insert>

    <delete id="deleteRegistration" parameterType="String">
        DELETE FROM user_registration WHERE user_id = #{userId}
    </delete>
</mapper>