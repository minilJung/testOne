<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ebc.ecard.mapper.ECardCaptureScheduleMapper">

	<sql id="captureScheduleDefault">
		SELECT
			schedule_id as scheduleId,
			ecard_id as ecardId,
			status as status,
            retry_count as retryCount,
            created_at as createdAt,
            processed_at as processedAt
		FROM ecard_capture_schedule
	</sql>

	<insert id="addScheduleById" parameterType="ECardCaptureScheduleBean">
		INSERT INTO ecard_capture_schedule(
			schedule_id,
			ecard_id,
			status,
			created_at
		)
		VALUES(
		    #{scheduleId},
		    #{ecardId},
			#{status},
		   	#{createdAt}
		);

	</insert>

	<select id="findScheduleById" parameterType="String" resultType="ECardCaptureScheduleBean">
		<include refid="captureScheduleDefault" />
		WHERE schedule_id = #{scheduleId}
	</select>

	<select id="findRemainSchedules" parameterType="ECardCaptureScheduleFilterDto" resultType="ECardCaptureScheduleBean">
		<include refid="captureScheduleDefault" />

		<where>
			status = 'P'
			AND  <![CDATA[retry_count < 4]]>
		</where>

		ORDER BY created_at ASC
		<if test="chunk > 0">
			LIMIT #{chunk};
		</if>
	</select>

	<update id="updateSchedule" parameterType="ECardCaptureScheduleBean">
		UPDATE ecard_capture_schedule
		SET
		    status = #{status},
		    retry_count = #{retryCount},
		    processed_at = now()
		WHERE
		    schedule_id = #{scheduleId}
	</update>

	<delete id="cancelRemainingSchedules" parameterType="String">
		DELETE FROM ecard_capture_schedule
		WHERE ecard_id = #{ecardId}
	</delete>

</mapper>